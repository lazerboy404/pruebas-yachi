<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pachuca</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://tile.openstreetmap.org">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css?v=12">
    <link rel="stylesheet" href="responsive.css?v=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">

    <style>
        body { font-family: 'Poppins', sans-serif; }

        .kpi-summary {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .kpi-card {
            min-width: 140px;
            flex: 0 1 auto;
            margin: 0;
        }

        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1;
            image-rendering: -webkit-optimize-contrast;
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado: ', reg.scope))
                    .catch(err => console.log('SW error: ', err));
            });
        }
    </script>
</head>
<body>

    <header style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
        <h1 style="margin: 0; flex: 1; text-align: center;">DASHBOARD GENERAL</h1>
        <button id="install-btn" style="display:none; position: absolute; top: 15px; right: 20px; background: #3498db; color: white; border: none; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; align-items: center; justify-content: center; gap: 6px;" title="Instalar Aplicación">
            <i class="fa-solid fa-download"></i> App
        </button>
    </header>

    <main>
        <section class="kpi-summary">
            <div class="kpi-card">
                <h3>Total:</h3>
                <p id="total-cameras">0</p>
            </div>

            <div class="kpi-card success">
                <h3>Operativas:</h3>
                <p id="operative-count">0</p>
            </div>

            <div class="kpi-card" style="border-left: 5px solid #3498db;">
                <h3>Configuradas:</h3>
                <p id="configured-count">0</p>
            </div>

            <div class="kpi-card warning">
                <h3>Pendientes:</h3>
                <p id="pending-count">0</p>
            </div>
        </section>

        <section style="margin-top: 20px; padding: 0 20px;">
            <h2 style="color: #ffffff; margin-bottom: 10px; text-align: center;">Ubicación de Dispositivos</h2>
            <div id="map"></div>
        </section>
    </main>

    <a href="gestion.html" class="fab-btn" title="Ir a Gestión" style="right: 30px;">
        <i class="fa-solid fa-list-check"></i>
    </a>
    
    <a href="evidencias.html" class="fab-btn" title="Ir a Evidencias" style="right: 100px; background-color: #3498db;">
        <i class="fa-solid fa-camera"></i>
    </a>
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>

    <div id="install-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; flex-direction: column;">
        <div style="background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0; color: #2c3e50; margin-bottom: 15px;">Instalando Aplicación...</h3>
            <div style="width: 100%; background: #ecf0f1; height: 12px; border-radius: 6px; margin: 20px 0; overflow: hidden; position: relative;">
                <div id="install-progress" style="width: 0%; height: 100%; background: #3498db; transition: width 0.1s linear; border-radius: 6px;"></div>
            </div>
            <p id="install-text" style="margin: 0; font-size: 14px; color: #7f8c8d; font-weight: 500;">Preparando archivos...</p>
        </div>
    </div>

    <script>
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installBtn) {
                installBtn.style.display = 'flex';
                installBtn.onclick = async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response to the install prompt: ${outcome}`);
                        
                        if (outcome === 'accepted') {
                            installBtn.style.display = 'none';
                            const modal = document.getElementById('install-modal');
                            const bar = document.getElementById('install-progress');
                            const text = document.getElementById('install-text');
                            
                            if (modal) {
                                modal.style.display = 'flex';
                                let width = 0;
                                const interval = setInterval(() => {
                                    width += 2; // Slower progress
                                    if (width > 100) width = 100;
                                    
                                    bar.style.width = width + '%';
                                    
                                    if (width < 30) text.textContent = "Preparando entorno...";
                                    else if (width < 60) text.textContent = "Descargando recursos...";
                                    else if (width < 90) text.textContent = "Configurando modo offline...";
                                    else text.textContent = "Finalizando instalación...";
                                    
                                    if (width >= 100) {
                                        clearInterval(interval);
                                        text.textContent = "¡Instalación completada!";
                                        text.style.color = "#27ae60";
                                        setTimeout(() => {
                                            modal.style.display = 'none';
                                        }, 1500);
                                    }
                                }, 50); // 50ms * 50 steps = 2.5 seconds
                            }
                        }
                        
                        deferredPrompt = null;
                    }
                };
            }
        });

        window.addEventListener('appinstalled', () => {
            if (installBtn) installBtn.style.display = 'none';
            deferredPrompt = null;
            console.log('PWA was installed');
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDz17f-cSbHRgBnyDnBsSjVDfAI4mSZ_0",
            authDomain: "pachuca-uaeh.firebaseapp.com",
            projectId: "pachuca-uaeh",
            storageBucket: "pachuca-uaeh.firebasestorage.app",
            messagingSenderId: "111780147134",
            appId: "1:111780147134:web:32634929b7427d21b1d3ef",
            measurementId: "G-M7303H8HBM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const camarasRef = collection(db, "camaras");

        const totalEl = document.getElementById("total-cameras");
        const operativasEl = document.getElementById("operative-count");
        const pendientesEl = document.getElementById("pending-count");
        const configuradasEl = document.getElementById("configured-count");

        // Inicialización Mapa
        const map = L.map('map').setView([20.128137, -98.805992], 16);

        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 22,
            attribution: '© Google Maps'
        }).addTo(map);

        // Icono personalizado
        var cameraIcon = L.icon({
            iconUrl: 'camara.png', 
            iconSize:     [32, 32],
            iconAnchor:   [16, 16],
            popupAnchor:  [0, -10]
        });

        const markersLayer = L.layerGroup().addTo(map);

        onSnapshot(camarasRef, (snapshot) => {
            let total = 0, operativas = 0, pendientes = 0, configuradas = 0;
            
            markersLayer.clearLayers();

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                total++;

                const estado = data.estado ? data.estado.trim().toLowerCase() : "";

                if (estado === "operativa") operativas++;
                else if (estado === "pendiente") pendientes++;
                else if (estado === "configurada") configuradas++;

                // Lógica para procesar coordenadas (String o campos separados)
                let lat = null;
                let lng = null;

                if (data.coordenadas) {
                    const partes = data.coordenadas.split(',');
                    if (partes.length === 2) {
                        lat = parseFloat(partes[0].trim());
                        lng = parseFloat(partes[1].trim());
                    }
                } else if (data.lat && data.lng) {
                    lat = parseFloat(data.lat);
                    lng = parseFloat(data.lng);
                }

                if (lat && lng) {
                    let statusColor = "black";
                    if(estado === "operativa") statusColor = "#2ecc71";
                    if(estado === "pendiente") statusColor = "#f39c12";
                    if(estado === "configurada") statusColor = "#3498db";

                    // --- CAMBIO AQUÍ: Añadimos draggable: true ---
                    const marker = L.marker([lat, lng], { 
                        icon: cameraIcon,
                        draggable: true 
                    }).bindPopup(`
                        <div style="font-size:14px;">
                            <b>ID:</b> ${data.idCamara || docSnap.id}<br>
                            <b>Modelo:</b> ${data.modelo || "N/A"}<br>
                            <b>Estado:</b> <span style="color:${statusColor}; font-weight:bold;">${estado.toUpperCase()}</span><br>
                            <hr style="margin: 5px 0;">
                            <i class="fa-solid fa-network-wired"></i> ${data.ip || "Sin IP"}
                            <p style="font-size: 10px; color: #888; margin-top:5px;">Arrastra para mover</p>
                        </div>
                    `);

                    // --- NUEVA LÓGICA: Evento para guardar en Firebase al soltar ---
                    marker.on('dragend', async function(event) {
                        const markerPos = event.target.getLatLng();
                        const nuevaCoordenada = `${markerPos.lat.toFixed(6)}, ${markerPos.lng.toFixed(6)}`;
                        
                        try {
                            // Actualizamos el documento en la colección "camaras" usando el ID de Firebase
                            await updateDoc(doc(db, "camaras", docSnap.id), {
                                coordenadas: nuevaCoordenada
                            });
                            console.log(`Ubicación actualizada para ${data.idCamara}: ${nuevaCoordenada}`);
                        } catch (error) {
                            console.error("Error al actualizar la ubicación:", error);
                            alert("No se pudo guardar la nueva ubicación.");
                        }
                    });
                    
                    markersLayer.addLayer(marker);
                }
            });

            totalEl.textContent = total;
            operativasEl.textContent = operativas;
            pendientesEl.textContent = pendientes;
            if (configuradasEl) configuradasEl.textContent = configuradas;
        });
    </script>

</body>
</html>
